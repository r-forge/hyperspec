NAME = cbmisc
DIR = pkg/$(NAME)
SRC := $(DIR)/R/*.R 
MAN := $(DIR)/man/*.Rd
RNW := $(DIR)/inst/doc/*.Rnw


all: roxy build check install

.FORCE: # always done, like .PHONY, but doesn't remove file


www/$(NAME)-prebuilt.zip: # built manually 
	touch $@

#####################################################################################################

DESCRIPTION: $(shell find $(DIR) -maxdepth 1 -daystart -not -ctime 0 -name "DESCRIPTION") #only if not modified today
				 /bin/echo $@
	@/bin/echo update DESCRIPTION
	sed "s/\(^Version: .*-\)20[0-9][0-9][0-1][0-9][0-3][0-9]\(.*\)$$/\1`date +%Y%m%d`\2/" $(DIR)/DESCRIPTION > .DESCRIPTION
	sed "s/\(^Date: .*\)20[0-9][0-9]-[0-1][0-9]-[0-3][0-9]\(.*\)$$/\1`date +%F`\2/" .DESCRIPTION > $(DIR)/DESCRIPTION 
	rm .DESCRIPTION

roxy: clean DESCRIPTION $(SRC)
	Rscript -e "library (methods); library (roxygen2); roxygenize (package.dir='$(DIR)')" 

build: roxy
	rm -f $(NAME)_*.tar.gz
	R CMD build $(DIR)  && cp $(NAME)_*.tar.gz www/$(NAME)-prebuilt.tar.gz

check: build
	R CMD check $(NAME)_*.tar.gz

devcheck: devbuild
	~/r-devel/bin/R CMD check $(NAME)_*.tar.gz

checkfast: $(SRC)
	R CMD check --no-examples --no-tests --no-manual --no-vignettes $(DIR)

checktest: $(SRC)
	R CMD check --no-manual --no-vignettes $(DIR)

clean: .FORCE

install:
		sudo R CMD INSTALL $(DIR)	
